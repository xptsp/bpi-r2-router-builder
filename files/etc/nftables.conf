# List a chain in the table:     nft list chain inet firewall <chain_name>
# List the elements in a map:    nft list map inet firewall <map_name>
# Get handle for rule in chain:  nft -a list chain inet firewall <chain_name> | grep "<search_spec>" | awk '{print $NF}'
# Delete rule from a chain:      nft delete rule inet firewall <chain_name} handle <handle>
# Add an element to the map:     nft add element inet firewall port_forward { 80 : 192.168.1.1 . 80 }
# Remove an element to the map:  nft delete element inet firewall port_forward { 80 : 192.168.1.1 . 80 }
 
#############################################################################
# Define WAN (Wide Area Network) and LAN (Local Area Network) interfaces.
# NOTE: WAN interfaces face the world.  LAN are ethernet & wireless.
# Defaults are my interfaces, which will be replaced by "nftables-script.sh".
#############################################################################
define DEV_LAN = { br0, mt7615_24g, mt7615_5g }
define DEV_WAN = { wan }
define DEV_NO_NET = { no_net }

#############################################################################
# Clear out our ruleset because we need to start fresh!
#############################################################################
add table inet firewall
flush table inet firewall

#############################################################################
# Define rules that affect both IPv4 and IPv6:
#############################################################################
table inet firewall {

	#############################################################################
	chain prerouting_private {
		drop
	}

	#############################################################################
	chain prerouting {
		# Default Post-Routing policy is "ACCEPT":
		type filter hook prerouting priority dstnat; policy accept;
		
		# Drop invalid packets:
		ct state invalid drop

		# This blocks all packets that are new (don’t belong to an established connection) and don’t use the SYN flag.
		tcp flags & (fin|syn|rst|ack) != syn ct state new drop
		
		# Block Packets With Bogus TCP Flags:
		tcp flags & (fin|syn) == fin|syn drop
		tcp flags & (syn|rst) == syn|rst drop
		tcp flags & (fin|rst) == fin|rst drop
		tcp flags & (fin|ack) == fin drop
		tcp flags & (ack|urg) == urg drop
		tcp flags & (psh|ack) == psh drop
		tcp flags & (fin|syn|rst|psh|ack|urg) == 0x0 drop

		# Block fragmented packets:
		ip frag-off & 0x1fff != 0 counter drop

		# Block Packets From Private Subnets from WAN interfaces.  WAN interfaces should insert an 
		# "return" on their IP address/range into the "prerouting_private" chain in order to 
		# keep double-nat configurations working as expected:
		iifname $DEV_WAN ip saddr { 0.0.0.0/8, 10.0.0.0/8, 169.254.0.0/16, 172.16.0.0/12, 192.0.2.0/24, 192.168.0.0/16, 224.0.0.0/5, 240.0.0.0/5 } jump prerouting_private

		# Block Packets from spoofing as the "lo" interface:
		iifname != "lo" ip saddr 127.0.0.0/8 drop
	}

	#############################################################################
	chain inbound_wan {
	}

	#############################################################################
	chain inbound {
		# Default Inbound policy is "DROP":
		type filter hook input priority 0; policy drop;

		# Block Flooding of RST packets, SMURF attack Rejection
		meta l4proto icmp limit rate 2/second burst 2 packets accept

		# Allow traffic from established and related packets, drop invalid
		ct state vmap { established : accept, related : accept, invalid : drop }

		# Redirect incoming port 67 to port 68:
		meta l4proto udp udp sport 67 udp dport 68 accept

		# Jump to "inbound_wan" chain for our WAN interfaces:
		iifname $DEV_WAN jump inbound_wan

		# Allow traffic from loopback and LAN interfaces:
		iifname { lo, $DEV_LAN } accept
	}

	#############################################################################
	chain forward_to_wan {
	}

	#############################################################################
	chain forward_to_lan {
	}

	#############################################################################
	chain forward {
		# Default Forwarding policy is "DROP":
		type filter hook forward priority 0; policy drop;

		# Automatically accept all our DNATed packets:
		ct status dnat accept

		# Allow traffic from established and related packets, drop invalid:
		ct state vmap { established : accept, related : accept, invalid : drop }

		# Drop all connections to WAN interfaces from any interfaces with "no_internet" flag set:
		iifname $DEV_NO_NET oifname $DEV_WAN drop

		# LAN to WAN communication must jump to "forward_to_wan" chain now:
		iifname $DEV_LAN oifname $DEV_WAN jump forward_to_wan

		# Forward connections from the LAN interfaces to WAN interfaces:
		iifname $DEV_LAN oifname $DEV_WAN accept
		
		# LAN to LAN communication must jump to "forward_to_lan" chain now:
		iifname $DEV_LAN oifname $DEV_LAN jump forward_to_lan

		# Forward connections from the LAN interfaces to LAN interfaces:
		iifname $DEV_LAN oifname $DEV_LAN accept
	}

	######################################################
	chain postrouting {
		# Default Post-Routing policy is "ACCEPT":
		type nat hook postrouting priority 100; policy accept;

		# Masquerade everything going out on our WAN interfaces:
		oifname $DEV_WAN masquerade

		# Forward ports specified in "port_forward" map: 
	}

	#############################################################################
	chain outbound_vpn {
		# Default policy is to block from accessing anything but the "lo" interface.
		# This policy will be replaced by the OpenVPN configuration script when connecting.
		oifname != "lo" drop
	}

	#############################################################################
	chain outbound_wan {
	}

	#############################################################################
	chain outbound_lan {
	}

	#############################################################################
	chain outbound {
		# Default Output policy is "ACCEPT":
		type filter hook output priority 0; policy accept;

		# User "vpn" must jump to the "outbound_vpn" chain now:
		meta skuid "vpn" jump outbound_vpn

		# All WAN interfaces must jump to the "outbound_wan" chain now:
		oifname $DEV_WAN jump outbound_wan

		# All LAN interfaces must jump to the "outbound_lan" chain now:
		oifname $DEV_LAN jump outbound_lan
	}
}
