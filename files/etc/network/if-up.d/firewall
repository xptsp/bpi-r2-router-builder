#!/bin/bash

# Use Receive Packet Steering (RPS) to steer incoming data from "wan" to CPUs 2 and 3:
[[ "${IFACE}" == "wan" ]] && echo 6 > /sys/class/net/${IFACE}/queues/rx-0/rps_cpus

# Use Receive Packet Steering (RPS) to steer incoming data from "br0" to CPUs 4:
[[ "${IFACE}" == "br0" ]] && echo 8 > /sys/class/net/${IFACE}/queues/rx-0/rps_cpus

# Put the IP address of a masquerade interface in the firewall's "prerouting_private" chain.
# This should allow double-nat configurations to work properly: 
if [[ ! -z "${IF_MASQUERADE}" ]]; then
	nft insert rule inet firewall prerouting_private iifname ${IFACE} ip saddr $(ip addr show ${IFACE} | grep " inet " | awk '{print $2}') accept
	nft insert rule inet firewall prerouting_private iifname ${IFACE} ip6 saddr $(ip addr show ${IFACE} | grep " inet6 " | awk '{print $2}') accept
	/opt/bpi-r2-router-builder/helpers/router-helper.sh dns config
fi

# Exit with a zero error code:
exit 0
