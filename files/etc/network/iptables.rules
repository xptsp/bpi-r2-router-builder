*nat
# Allow masquerading connections as from wan interface
-A POSTROUTING -o wan -j MASQUERADE

# Don't delete the 'COMMIT' line or these nat table rules won't be processed
COMMIT

*filter
-N DOCKER-USER

# Default policy: Drop all incoming connections
:INPUT DROP [0:0]

# Default policy: Allow all outgoing connections
:OUTPUT ACCEPT [0:0]

# Default policy: Drop all forwarded connections
:FORWARD DROP [0:0]

# Accept all connections from localhost
-A INPUT -i lo -j ACCEPT

# Accept all connections from br0 (our lan bridge)
-A INPUT -i br0 -j ACCEPT

# Accept all connections from br1 (our docker bridge)
-A INPUT -i br1 -j ACCEPT

# Accept all established and related connections from wan
-A INPUT -i wan -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Forward everything from br0 to br1
-A FORWARD -i br0 -o br1 -j ACCEPT

# Forward everything from br1 to br0
-A FORWARD -i br1 -o br0 -j ACCEPT

# Forward everything from br0 to wan
-A FORWARD -i br0 -o wan -j ACCEPT

# Forward everything from br1 to wan
-A FORWARD -i br1 -o wan -j ACCEPT

# Forward established and related connections from wan to br0
-A FORWARD -i wan -o br0 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# Forward established and related connections from wan to br1
-A FORWARD -i wan -o br1 -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT

# (?)
-I DOCKER-USER -i br0 -o wan -j ACCEPT
-I DOCKER-USER -i br1 -o wan -j ACCEPT

# Don't delete the 'COMMIT' line or these nat table rules won't be processed
COMMIT

