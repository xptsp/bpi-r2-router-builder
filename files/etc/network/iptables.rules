# IPV4 FIREWALL RULES
# see http://ipset.netfilter.org/iptables.man.html

*mangle
:PREROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# (?)
-A INPUT -i wan -s 10.2.0.0/16 -d 239.0.0.0/8 -p udp -j DROP

# Don't delete the 'COMMIT' line or these rules won't be processed
COMMIT

*nat
:PREROUTING ACCEPT [0:0]
:POSTROUTING ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]

# Masquerade all connections on the WAN interface:
-A POSTROUTING -o wan -j MASQUERADE

# Don't delete the 'COMMIT' line or these rules won't be processed
COMMIT

*filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
:SERVICES - [0:0]

# Reject everything coming from user VPN:
-A OUTPUT ! -o lo -m owner --uid-owner vpn -j DROP

# Allow all related/established connections:
-A INPUT -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Drop any invalid packets:
-A INPUT -m conntrack --ctstate INVALID -j DROP

# Accept all IGMP requests on WAN interface:
-A INPUT -i wan -p igmp -j ACCEPT

# Accept incoming port 67 on port 68 on WAN interface:
-A INPUT -i wan -p udp -m udp --sport 67 --dport 68 -j ACCEPT

# Direct WAN interface to check SERVICES table for further rules:
-A INPUT -i wan -j SERVICES

# Drop everything else on the WAN interface:
-A INPUT -i wan -j DROP

# Allow everything on the LO interface:
-A INPUT -i lo -j ACCEPT

# Allow everything on bridge interfaces:
-A INPUT -i br+ -j ACCEPT

# Reject all other input connections:
-A INPUT -j REJECT

# Forward all related/established connections:
-A FORWARD -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Drop invalid packets:
-A FORWARD -m conntrack --ctstate INVALID -j DROP

# Forward any connections to and from any bridge interfaces:
-A FORWARD -i br+ -o br+ -j ACCEPT

# Forward connections from any bridge to WAN:
-A FORWARD -i br+ -o wan -j ACCEPT

# Forward any related/established connections back to bridge interfaces:
-A FORWARD -i wan -o br+ -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# (?)
-A FORWARD -i wan -o br+ -s 10.2.0.0/16 -d 239.0.0.0/8 -p udp -j ACCEPT

# Drop any other connections on the WAN interface:
-A FORWARD -i wan -j DROP

# Drop any other connections on the WAN interface:
-A FORWARD -j REJECT

#-A SERVICES -p tcp --dport 22 -j ACCEPT
#-A SERVICES -p udp --dport 1194 -j ACCEPT

# Don't delete the 'COMMIT' line or these rules won't be processed
COMMIT
