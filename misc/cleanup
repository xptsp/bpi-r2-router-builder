#!/bin/bash
if [[ "$UID" -ne 0 ]]; then
	sudo $0 $@
	exit
fi
RED='\033[1;31m'
GREEN='\033[1;32m'
BLUE='\033[1;34m'
NC='\033[0m'

los() {
	img="$1"
	dev="$(sudo losetup --show -f -P "$img")"
	echo "$dev"
	for part in "$dev"?*; do
		[ "$part" = "${dev}p*" ] && part="${dev}"
		dst="/mnt/$(basename "$part")"
		echo "$dst"
		sudo mkdir -p "$dst"
		sudo mount "$part" "$dst"
	done
}
losd() {
	for part in "${1}"?*; do
		if [ "${part}" = "${1}p*" ]; then
			part="${1}"
		fi
		dst="/mnt/$(basename "$part")"
		sudo umount "$dst"
		sudo rmdir "$dst"
	done
	sudo losetup -d "$1"
}

####################################################################################################
FILE="${1}"
if [[ -z "${FILE}" || ! -e "${FILE}" ]]; then
	# Assemble the list of files to display:
	count=0
	while read -r file
	do
		 options+=($((++count)) "$file")
	done <<< $(ls -r *.img*)

	# Display the dialog box:
	cmd=(dialog --keep-tite --menu "Select Image to Clean:" 22 76 16)
	CHOICE=$("${cmd[@]}" "${options[@]}" 2>&1 >/dev/tty)
	[[ "$CHOICE" -eq 0 ]] && exit 0
	FILE=${options[ $(( $CHOICE * 2 - 1)) ]}
fi
echo -e "${GREEN}================================================================${NC}"
echo -e "${GREEN}NOTE:${NC} Cleaning up ${BLUE}${FILE}${NC}...."

####################################################################################################
echo -e "${GREEN}================================================================${NC}"
echo -e "${GREEN}NOTE:${NC} Mounting partitions within the image..."
DEV=($(los ${FILE}))

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Extracting empty BPIWRT disk image..."
[[ "$(df /tmp | grep -v Filesystem | head -1 | awk '{print $4}')" -lt 2129921 ]] && DEST=./ || DEST=/tmp
cp $(dirname $(ls -l $0 | awk '{print $NF}'))/bpiwrt_empty.img.gz ${DEST}
gunzip -f ${DEST}/bpiwrt_empty.img.gz

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Copy kernel files from partition 1..."
OUT=($(los ${DEST}/bpiwrt_empty.img))
rm ${DEV[1]}/bananapi/bpi-r2/linux/uImage >& /dev/null
rm ${DEV[1]}/{eth0,wifi}.conf >& /dev/null
cp -aR ${DEV[1]}/* ${OUT[1]}/

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Clearing the local repository of retrieved package files..."
A=${DEV[2]}
chroot ${A} apt-get clean
chroot ${A} apt-get autoclean
echo -e "${GREEN}NOTE:${NC} Purge unnecessary packages..."
chroot ${A} apt-get -y purge --autoremove
if [[ -f ${A}/usr/local/bin/pihole ]]; then
	echo -e "${GREEN}NOTE:${NC} Clearing PiHole stats..."
	chroot ${A} pihole -f
fi

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Removing unnecessary files from partition 2..."
rm -rf ${A}/tmp/* >& /dev/null
rm -rf ${A}/root/.config >& /dev/null
rm -rf ${A}/root/.local >& /dev/null
rm ${A}/etc/udev/rules.d/70-persistent-net.rules >& /dev/null
rm ${A}/root/.bash_history >& /dev/null
rm ${A}/root/.ssh/known_hosts >& /dev/null
rm ${A}/var/lib/vnstat/* >& /dev/null
rm ${A}/var/misc/* >& /dev/null
rm ${A}/var/cache/apt/*.bin >& /dev/null
rm ${A}/lib/modules/$(ls ${A}/lib/modules/)/{build,source} >& /dev/null
rm -r ${A}/var/log/*.{xz,gz,1,2} >& /dev/null
for file in $(find ${A}/var/log -type f | grep -v /var/log/apt/history.log); do echo -n > $file; done
cat /var/log/apt/history.log | tail -3 > /tmp/history.log
mv /tmp/history.log /var/log/apt/history.log
rm ${A}/var/lib/apt/lists/* >& /dev/null
rm ${A}/etc/samba/smb.d/router >& /dev/null
touch ${A}/var/lib/apt/lists/lock
cp ${A}/opt/bpi-r2-router-builder/files/etc/hostapd/* ${A}/etc/hostapd/

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Copy system files from partition 2..."
cp -aR ${DEV[2]}/* ${OUT[2]}/

####################################################################################################
echo -e "${GREEN}NOTE:${NC} Unmount partitions from system..."
losd ${DEV[0]}
losd ${OUT[0]}
mv ${DEST}/bpiwrt_empty.img ${FILE}

####################################################################################################
echo -e "${GREEN}================================================================${NC}"
echo -e "${GREEN}NOTE:${NC} Compressing image..."
gzip -fkv ${FILE}
echo -e "${GREEN}================================================================${NC}"
echo -e "${GREEN}SUCCESS!${NC}  Image backup completed and prepped successfully!"
